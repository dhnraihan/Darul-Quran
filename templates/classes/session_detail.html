{% extends 'base.html' %}
{% load i18n %}

{% block title %}{% trans "Class Session Details" %} - Amar Quran{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <div class="bg-white rounded-lg shadow-md">
        <!-- Session Header -->
        <div class="bg-gradient-to-r from-green-600 to-green-700 text-white p-6 rounded-t-lg">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-2xl font-bold mb-2">{{ session.course.title }}</h1>
                    <p class="text-green-100">
                        <i class="far fa-calendar mr-2"></i>{{ session.date|date:"l, F d, Y" }}
                        <span class="mx-2">|</span>
                        <i class="far fa-clock mr-2"></i>{{ session.start_time|time:"g:i A" }} - {{ session.end_time|time:"g:i A" }}
                    </p>
                </div>
                <span class="px-3 py-1 bg-white/20 rounded-full text-sm">
                    {{ session.get_status_display }}
                </span>
            </div>
        </div>
        
        <!-- Session Details -->
        <div class="p-6">
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- Left Column -->
                <div class="space-y-4">
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">{% trans "Teacher" %}</h3>
                        <div class="flex items-center">
                            {% if session.teacher.profile_picture %}
                                <img src="{{ session.teacher.profile_picture.url }}" alt="{{ session.teacher.get_full_name }}" 
                                     class="w-10 h-10 rounded-full mr-3">
                            {% else %}
                                <div class="w-10 h-10 rounded-full bg-gray-300 mr-3"></div>
                            {% endif %}
                            <div>
                                <p class="font-medium">{{ session.teacher.get_full_name }}</p>
                                <p class="text-sm text-gray-600">{{ session.teacher.email }}</p>
                            </div>
                        </div>
                    </div>
                    
                    {% if user == session.teacher %}
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">{% trans "Student" %}</h3>
                        <div class="flex items-center">
                            {% if session.student.profile_picture %}
                                <img src="{{ session.student.profile_picture.url }}" alt="{{ session.student.get_full_name }}" 
                                     class="w-10 h-10 rounded-full mr-3">
                            {% else %}
                                <div class="w-10 h-10 rounded-full bg-gray-300 mr-3"></div>
                            {% endif %}
                            <div>
                                <p class="font-medium">{{ session.student.get_full_name }}</p>
                                <p class="text-sm text-gray-600">{{ session.student.email }}</p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">{% trans "Platform" %}</h3>
                        <p class="font-medium">
                            <i class="fas fa-video mr-2 text-gray-400"></i>
                            {{ session.get_platform_display }}
                        </p>
                    </div>
                    
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">{% trans "Duration" %}</h3>
                        <p class="font-medium">{{ session.duration_minutes }} {% trans "minutes" %}</p>
                    </div>
                </div>
                
                <!-- Right Column -->
                <div class="space-y-4">
                    {% if session.topic %}
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">{% trans "Topic" %}</h3>
                        <p class="font-medium">{{ session.topic }}</p>
                    </div>
                    {% endif %}
                    
                    {% if session.objectives %}
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">{% trans "Learning Objectives" %}</h3>
                        <p class="text-gray-700">{{ session.objectives|linebreaks }}</p>
                    </div>
                    {% endif %}
                    
                    {% if session.homework %}
                    <div>
                        <h3 class="text-sm font-medium text-gray-500 mb-1">{% trans "Homework/Assignment" %}</h3>
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3">
                            <p class="text-gray-700">{{ session.homework|linebreaks }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Meeting Link Section -->
            {% if session.status == 'scheduled' and session.is_upcoming %}
            <div class="border-t pt-6">
                <h3 class="font-semibold text-gray-800 mb-4">{% trans "Join Class" %}</h3>
                
                {% if session.meeting_link %}
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-3">{% trans "Click the button below to join your class:" %}</p>
                        <a href="{{ session.meeting_link }}" target="_blank" 
                           class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                            <i class="fas fa-video mr-2"></i>{% trans "Join Class Now" %}
                        </a>
                        {% if session.meeting_id %}
                            <p class="text-sm text-gray-600 mt-3">
                                <strong>{% trans "Meeting ID:" %}</strong> {{ session.meeting_id }}
                            </p>
                        {% endif %}
                        {% if session.meeting_password %}
                            <p class="text-sm text-gray-600">
                                <strong>{% trans "Password:" %}</strong> {{ session.meeting_password }}
                            </p>
                        {% endif %}
                    </div>
                {% elif session.platform == 'whatsapp' %}
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <p class="text-sm text-gray-600 mb-3">{% trans "Join via WhatsApp:" %}</p>
                        <a href="{{ session.get_whatsapp_link }}" target="_blank" 
                           class="inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                            <i class="fab fa-whatsapp mr-2"></i>{% trans "Open WhatsApp" %}
                        </a>
                    </div>
                {% else %}
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <p class="text-yellow-800">
                            <i class="fas fa-info-circle mr-2"></i>
                            {% trans "Meeting link will be available shortly before the class starts." %}
                        </p>
                    </div>
                {% endif %}
            </div>
            {% endif %}
            
            <!-- Notes Section (for teacher) -->
            {% if user == session.teacher %}
            <div class="border-t pt-6">
                <h3 class="font-semibold text-gray-800 mb-4">{% trans "Session Notes" %}</h3>
                <form method="post" action="{% url 'classes:update_notes' session.session_id %}">
                    {% csrf_token %}
                    <textarea name="teacher_notes" rows="4" 
                              class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:border-green-500"
                              placeholder="{% trans 'Add private notes about this session...' %}">{{ session.teacher_notes }}</textarea>
                    <button type="submit" class="mt-2 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
                        {% trans "Save Notes" %}
                    </button>
                </form>
            </div>
            {% endif %}
            
            <!-- Recording Section -->
            {% if session.recording_url and session.status == 'completed' %}
            <div class="border-t pt-6">
                <h3 class="font-semibold text-gray-800 mb-4">{% trans "Session Recording" %}</h3>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-sm text-gray-600 mb-3">{% trans "Watch the recording of this session:" %}</p>
                    <a href="{{ session.recording_url }}" target="_blank" 
                       class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-play-circle mr-2"></i>{% trans "Watch Recording" %}
                    </a>
                </div>
            </div>
            {% endif %}
            
            <!-- Action Buttons -->
            <div class="border-t pt-6 flex flex-wrap gap-3 justify-end">
                {% if session.status == 'scheduled' and session.is_upcoming %}
                    {% if user == session.teacher or user == session.student %}
                        <a href="{% url 'classes:reschedule' session.session_id %}" 
                           class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition">
                            <i class="fas fa-calendar-alt mr-2"></i>{% trans "Reschedule" %}
                        </a>
                        <button onclick="confirmCancel('{{ session.session_id }}')" 
                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                            <i class="fas fa-times-circle mr-2"></i>{% trans "Cancel Session" %}
                        </button>
                    {% endif %}
                {% endif %}
                
                {% if user == session.teacher and session.status == 'scheduled' and not session.is_upcoming %}
                    <button onclick="markComplete('{{ session.session_id }}')" 
                            class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                        <i class="fas fa-check-circle mr-2"></i>{% trans "Mark as Complete" %}
                    </button>
                {% endif %}
                
                <a href="{% url 'classes:schedule' %}" 
                   class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                    <i class="fas fa-arrow-left mr-2"></i>{% trans "Back to Schedule" %}
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function confirmCancel(sessionId) {
    if (confirm('{% trans "Are you sure you want to cancel this session?" %}')) {
        fetch(`{% url 'classes:cancel' session.session_id %}`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            }
        });
    }
}

function markComplete(sessionId) {
    fetch(`{% url 'classes:complete' session.session_id %}`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    }).then(response => {
        if (response.ok) {
            window.location.reload();
        }
    });
}
</script>
{% endblock %}